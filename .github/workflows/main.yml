# This is a basic workflow to help you get started with Actions

name: Release pack

# Controls when the workflow will run
on:
    push:
        tags:
            - 'v*.*.*.*'
    workflow_dispatch:


# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
    # This workflow contains a single job called "build"
    build:
        # The type of runner that the job will run on
        runs-on: ubuntu-latest

        # Steps represent a sequence of tasks that will be executed as part of the job
        steps:
            # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
            - uses: actions/checkout@v2

            - name: Extract version from commit name
              id: check_commit_message
              run: |
                echo "::set-output name=version::$(echo ${{ github.ref }} | sed 's/^refs\/tags\/v//')"

            - name: Update package.json and ccmod.json
              run: | 
                sed -i "s/\"version\": \".*\"/\"version\": \"${{ steps.check_commit_message.outputs.version }}\"/" package.json ccmod.json

            - name: Create release
              id: create_release
              uses: softprops/action-gh-release@v1
              with:
                files: |
                  *.ccmod
                name: ${{ steps.check_commit_message.outputs.version }}
            
            - name: Run pack.sh
              run: ./pack.sh
            
            - name: Upload *.ccmod to release
              uses: actions/upload-artifact@v2
              with:
                name: release-artifact
                path: ./*.ccmod
            
            - name: Publish release artifact
              uses: softprops/action-gh-release@v1
              with:
                files: |
                  release-artifact/*.ccmod
